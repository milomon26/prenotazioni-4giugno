<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restituzioni di metà anno</title>

<style>
body{font-family:Arial,sans-serif;padding:2rem;background:#f8f8f8}
h1{text-align:center}
.slot{background:#fff;border:1px solid #ccc;padding:1rem;margin-bottom:1rem;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
.slot button{padding:.5rem 1rem;cursor:pointer}
#modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center}
#modalContent{background:#fff;padding:2rem;border-radius:10px;max-width:400px;width:100%;text-align:center}
#modalContent select{width:100%;padding:.5rem;margin-top:1rem}
#modalContent button{margin-top:1rem;padding:.5rem 1rem}
#messageBox{display:none;margin-top:1rem;padding:.75rem;border-radius:8px}
.success{background:#d4edda;color:#155724}
.error{background:#f8d7da;color:#721c24}
</style>
</head>

<body>

<h1>Restituzioni di metà anno</h1>
  <div id="slotsContainer"></div>
  <div id="counter" style="text-align: center; margin-top: 1rem; font-weight: bold;"></div>
  <div style="text-align: center; font-size: 0.95rem; margin-top: 0.25rem;">
    Se vuoi modificare lo slot prenotato, <em>senza fare danni</em>, <a href="https://docs.google.com/spreadsheets/d/1HbHICc_0tELzJ0xL_v7JSj_GseS_5n2q6vnKDrqAzug/edit" target="_blank">clicca qui</a> ed elimina <strong>SOLO</strong> la tua riga. Chiudi il file, ricarica la pagina e prenota un altro slot.
  </div>

  <div id="modal">
    <div id="modalContent">
      <span onclick="modal.style.display='none'" style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:20px;">&times;</span>
      <h3>Prenota lo slot: <span id="selectedSlot"></span></h3>
      <select id="nameInput" required></select>
      <br>
      <button onclick="confirmBooking()">Conferma</button>
      <div id="messageBox"></div>
    </div>
  </div>



<script>
const readURL="https://docs.google.com/spreadsheets/d/1HbHICc_0tELzJ0xL_v7JSj_GseS_5n2q6vnKDrqAzug/export?format=csv&gid=242056328";
const formURL="https://docs.google.com/forms/d/e/1FAIpQLScB0jxJYgDaNR-454T-cbb7DZOa-Tve8U2j-45GRMTK5fUu_A/formResponse";

const days=[
{label:"Mercoledì 4",date:"2025-06-04T14:30:00",slots:8},
{label:"Mercoledì 11",date:"2025-06-11T14:30:00",slots:8}
];

let bookings={};

const allNames=["ANNALISA","CRISTINA","ELENA","EZIO","FLAVIA","FLORIANA","GIUSEPPE","INES","LUISA","MONIA","PIETRO","ROBERTA","ROSALBA","SANDRA","SIMONETTA","VIVIANA"];

const slotsContainer=document.getElementById("slotsContainer");
const modal=document.getElementById("modal");
const messageBox=document.getElementById("messageBox");
let selectedSlotKey=null;

function showMessage(m,t){messageBox.textContent=m;messageBox.className=t;messageBox.style.display="block";setTimeout(()=>messageBox.style.display="none",3000)}

function generateSlots(){
let free=0,total=0;slotsContainer.innerHTML="";
days.forEach(day=>{
let start=new Date(day.date),end=new Date(start);end.setHours(16,0,0,0);
let mins=(end-start)/60000,base=Math.floor(mins/day.slots),extra=mins%day.slots;
let cur=new Date(start);
let h=document.createElement("h3");h.textContent=`${day.label} (14:30 - 16:00)`;slotsContainer.appendChild(h);

for(let i=0;i<day.slots;i++){
total++;
let dur=base+(i<extra?1:0);
let s=new Date(cur),e=new Date(cur.getTime()+dur*60000);
let key=`${day.label} ${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}`;
let label=`${key} → ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`;
let d=document.createElement("div");d.className="slot";
if(bookings[key])d.innerHTML=`<div>${label}</div><div>${bookings[key]}</div>`;
else{d.innerHTML=`<div>${label}</div><button onclick="openForm('${key}','${label}')">Prenota</button>`;free++}
slotsContainer.appendChild(d);cur=e;}
});
document.getElementById("counter").textContent=`${total-free}/${total}`;
}

function openForm(k,l){
selectedSlotKey=k;
document.getElementById("selectedSlot").textContent=l;
let s=document.getElementById("nameInput");s.innerHTML="";
Object.values(bookings).forEach(()=>{});
allNames.filter(n=>!Object.values(bookings).includes(n)).forEach(n=>{
let o=document.createElement("option");o.value=n;o.textContent=n;s.appendChild(o);
});
modal.style.display="flex";
}

function confirmBooking(){
let name=document.getElementById("nameInput").value;
if(!name)return showMessage("Seleziona un nome","error");
let fd=new FormData();
fd.append("entry.1009667509",selectedSlotKey);
fd.append("entry.104265613",name);
fd.append("entry.544993306",new Date().toISOString());

fetch(formURL,{method:"POST",mode:"no-cors",body:fd}).then(()=>{
bookings[selectedSlotKey]=name;
generateSlots();modal.style.display="none";showMessage("Prenotazione salvata","success");
});
}

function loadBookings(){
fetch(readURL).then(r=>r.text()).then(t=>{
let lines=t.trim().split("\n");bookings={};
lines.slice(1).forEach(l=>{
let p=l.split(",");if(p.length>=2){let k=p[0].replace(/"/g,"").trim(),v=p[1].replace(/"/g,"").trim();
if(k&&v)bookings[k]=v;}
});
generateSlots();
});
}

window.onclick=e=>{if(e.target==modal)modal.style.display="none"};
loadBookings();
</script>

</body>
</html>
